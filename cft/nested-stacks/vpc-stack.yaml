AWSTemplateFormatVersion: '2010-09-09'
Description: >-
   Project Helenium: CFN Template to launch one custom VPC, two public and two private subnets with 
   one internet gateway with VPC route. 

Metadata:
  TemplateName: vpc-stack.yaml
  TemplateType: VPC / Private and Private Subnets / Route tables / Internet Gateway / VPC Route.
  Version: 1.0.0
  Owner: Subhamay Bhattacharyya
  ProjectName: Helenium
  Last Modified: Dec 24, 2023
  Resources: 
    - One Custom VPC.
    - Two Public and two Private Subnets.
    - One Private and one Public Route Table.
    - One Internet Gateway with VPC Route.
  StepsToTest: |
    Manualy verify the Stack.
  StepsToCleanup: |
    Stack delete command

  AWS::CloudFormation::Interface:
    ParameterGroups:
    #################################### Project Name and Environment ##############################
    - Label:
        default: "Project Name And Environment:"
      Parameters:
      - ProjectName
      - Environment
    #################################### GitHub Attributes #########################################
    - Label:
        default: "GitHub Attributes:"
      Parameters:
      - GitHubRef
      - GitHubURL
      - GitHubWFRunNumber
      - GitHubSHA
      - GitHubRepository
      - CiBuild
    #################################### Custom Resource Stack #####################################
    - Label: 
        default: "Custom Resource Stack:"
      Parameters: 
      - CustomResourceStackName
    #################################### VPC and Subnet ############################################
    - Label:
        default: "VPC Cidr Block"
      Parameters:
      - VpcCidrBlock
    - Label:
        default: "Subnet Cidr Block"
      Parameters:
      - PublicSubnet1ACidrBlock
      - PublicSubnet1BCidrBlock
      - PrivateSubnet1ACidrBlock
      - PrivateSubnet1BCidrBlock
    ParameterLabels:
      ################################## Project Name and Environment ##############################
      ProjectName:
        default: "Project Name."
      Environment:
        default: "Environment Name."
      ################################## GitHub Attributes #########################################
      GitHubRef:
        default: "GitHub Ref."
      GitHubURL:
        default: "GitHub URL."
      GitHubWFRunNumber:
        default: "GitHub Workflow Run Number."
      GitHubSHA:
        default: "GitHub SHA"
      GitHubRepository:
        default: "GitHub Repository."
      CiBuild:
        default: "Ci Build."
      ################################## Custom Resource Stack #####################################
      CustomResourceStackName:
        default: "Custom Resource Stack"
      ################################## VPC and Subnet ############################################
      VpcCidrBlock:
        default: "VPC Cidr Block"
      PublicSubnet1ACidrBlock:
        default: "Public Subnet 1A Cidr Block"
      PublicSubnet1BCidrBlock: 
        default: "Public Subnet 1B Cidr Block"
      PrivateSubnet1ACidrBlock:
        default: "Private Subnet 1A Cidr Block"
      PrivateSubnet1BCidrBlock:
        default: "Private Subnet 1B Cidr Block"
Parameters:
  ###################################### Project Name and Environment ##############################
  ProjectName:
    Default: helenium
    Description: "The Project Name for which the custom resource will be used."
    Type: String
    MinLength: 5
    MaxLength: 20
    AllowedPattern: "[a-z]*"
    ConstraintDescription: "The length should be between 5 and 30, must contain only lowercase alphabets."
  Environment:
    Default: devl
    Description: "The Environment Name."
    Type: String
    AllowedValues: ["devl", "test", "prod"]
    ConstraintDescription: "The Environment must be devl / test or prod"
  ###################################### GitHub Attributes #########################################
  GitHubRef:
    Default: ref_name
    Description: "GitHub Ref Name"
    Type: String
  GitHubURL:
    Default: "https://github.com/"
    Description: "GitHub URL"
    Type: String
  GitHubWFRunNumber:
    Default: 1
    Description: "The Workfloww Run Number."
    Type: Number
  GitHubSHA:
    Default: "sha"
    Description: "The sha value of the last commit"
    Type: String
  GitHubRepository:
    Default: 001-tarius
    Description: "The GitHub Repository name."
    Type: String
    MinLength: 10
    MaxLength: 30
    AllowedPattern: "[a-z0-9-.]*"
    ConstraintDescription: "The reposiroty length should be between 10 and 30, must contain only lowercase letter,numbers,dash, dot and should start with a letter."
  CiBuild:
    Default: ""
    Description: "Ci Build of the feature branch."
    Type: String
  ###################################### Custom Resource Stack #####################################
  CustomResourceStackName:
    Default: 'ilac-custom-resource-stack'
    Description: 'S3 Custom Resource Stack Name'
    Type: String
  ###################################### VPC and Subnet ############################################
  VpcCidrBlock:
    Type: String
    Description: VPC CIDR Range
    Default: 172.16.0.0/16
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: "must be a valid IP CIDR range of the form x.x.x.x/x."
  PublicSubnet1ACidrBlock:
    Type: String
    Description: CidrBlock for Public 1A within the VPC.
    Default: 172.16.0.0/24
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: "must be a valid IP CIDR range of the form x.x.x.x/x."
  PublicSubnet1BCidrBlock:
    Type: String
    Description: CidrBlock for Public 1B within the VPC.
    Default: 172.16.1.0/24
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: "must be a valid IP CIDR range of the form x.x.x.x/x."
  PrivateSubnet1ACidrBlock:
    Type: String
    Description: CidrBlock for Private 1B within the VPC.
    Default: 172.16.2.0/24
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: "must be a valid IP CIDR range of the form x.x.x.x/x."
  PrivateSubnet1BCidrBlock:
    Type: String
    Description: CidrBlock for Private 1B within the VPC.
    Default: 172.16.3.0/24
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: "must be a valid IP CIDR range of the form x.x.x.x/x."
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties: 
      CidrBlock: !Ref VpcCidrBlock
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags: 
        - Key: Name
          Value: !Sub '${ProjectName}-vpc'
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: GitHubRepository
          Value: !Ref GitHubRepository
        - Key: GitHubRef
          Value: !Ref GitHubRef
        - Key: GitHubURL
          Value: !Ref GitHubURL
        - Key: GitHubWFRunNumber
          Value: !Ref GitHubWFRunNumber
        - Key: GitHubSHA
          Value: !Ref GitHubSHA
  CustomResourceLambdaTrigger:
    Type: Custom::RouteTableLambda
    Properties:
      ServiceToken: 
        Fn::ImportValue: !Sub '${CustomResourceStackName}-GetMainRouteTableCustomResourceLambdaFunctionArn'
      VPCID: !Ref VPC
  PublicSubnet1A:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1ACidrBlock 
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select: 
          - '0'
          - Fn::GetAZs: !Ref 'AWS::Region'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-pub-1a${CiBuild}'
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: GitHubRepository
          Value: !Ref GitHubRepository
        - Key: GitHubRef
          Value: !Ref GitHubRef
        - Key: GitHubURL
          Value: !Ref GitHubURL
        - Key: GitHubWFRunNumber
          Value: !Ref GitHubWFRunNumber
        - Key: GitHubSHA
          Value: !Ref GitHubSHA
  PublicSubnet1B:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1BCidrBlock 
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select: 
          - '1'
          - Fn::GetAZs: !Ref 'AWS::Region'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-pub-1b${CiBuild}'
        - Key: Environment
          Value: !Ref Environment
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: GitHubRepository
          Value: !Ref GitHubRepository
        - Key: GitHubRef
          Value: !Ref GitHubRef
        - Key: GitHubURL
          Value: !Ref GitHubURL
        - Key: GitHubWFRunNumber
          Value: !Ref GitHubWFRunNumber
        - Key: GitHubSHA
          Value: !Ref GitHubSHA
  PrivateSubnet1A:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1ACidrBlock
      AvailabilityZone:
        Fn::Select: 
          - '0'
          - Fn::GetAZs: !Ref 'AWS::Region'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-pvt-1a${CiBuild}'
        - Key: Environment
          Value: !Ref Environment
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: GitHubRepository
          Value: !Ref GitHubRepository
        - Key: GitHubRef
          Value: !Ref GitHubRef
        - Key: GitHubURL
          Value: !Ref GitHubURL
        - Key: GitHubWFRunNumber
          Value: !Ref GitHubWFRunNumber
        - Key: GitHubSHA
          Value: !Ref GitHubSHA
  PrivateSubnet1B:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1BCidrBlock 
      AvailabilityZone:
        Fn::Select: 
          - '1'
          - Fn::GetAZs: !Ref 'AWS::Region'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-pvt-1b${CiBuild}'
        - Key: Environment
          Value: !Ref Environment
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: GitHubRepository
          Value: !Ref GitHubRepository
        - Key: GitHubRef
          Value: !Ref GitHubRef
        - Key: GitHubURL
          Value: !Ref GitHubURL
        - Key: GitHubWFRunNumber
          Value: !Ref GitHubWFRunNumber
        - Key: GitHubSHA
          Value: !Ref GitHubSHA
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags: 
        - Key: Name
          Value: !Sub '${ProjectName}-pvt-rt${CiBuild}'
        - Key: Environment
          Value: !Ref Environment
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: GitHubRepository
          Value: !Ref GitHubRepository
        - Key: GitHubRef
          Value: !Ref GitHubRef
        - Key: GitHubURL
          Value: !Ref GitHubURL
        - Key: GitHubWFRunNumber
          Value: !Ref GitHubWFRunNumber
        - Key: GitHubSHA
          Value: !Ref GitHubSHA
  PrivateSubnet1ARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1A
      RouteTableId: !Ref PrivateRouteTable
  PrivateSubnet1BRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1B
      RouteTableId: !Ref PrivateRouteTable
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags: 
        - Key: Name
          Value: !Sub '${ProjectName}-igw${CiBuild}'
        - Key: Environment
          Value: !Ref Environment
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: GitHubRepository
          Value: !Ref GitHubRepository
        - Key: GitHubRef
          Value: !Ref GitHubRef
        - Key: GitHubURL
          Value: !Ref GitHubURL
        - Key: GitHubWFRunNumber
          Value: !Ref GitHubWFRunNumber
        - Key: GitHubSHA
          Value: !Ref GitHubSHA
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
  VPCRoute:
    Type: AWS::EC2::Route
    DependsOn:
         - PublicSubnet1A
         - PublicSubnet1B
         - PrivateSubnet1A
         - PrivateSubnet1B
         - VPCGatewayAttachment
    Properties:
      RouteTableId: !GetAtt CustomResourceLambdaTrigger.RouteTableID
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
Outputs:
  PublicSubnet1AId:
    Description: Public Subnet-1A Id
    Value: !Ref PublicSubnet1A
  PublicSubnet1BId:
    Description: Public Subnet-1B Id
    Value: !Ref PublicSubnet1B
  PrivateSubnet1AId:
    Description: Public Subnet-1A Id
    Value: !Ref PrivateSubnet1A
  PrivateSubnet1BId:
    Description: Public Subnet-1B Id
    Value: !Ref PrivateSubnet1B
  Subnet1AAvailabilityZone:
    Description: Availability Zone of Subnet 1A
    Value: !GetAtt PublicSubnet1A.AvailabilityZone
  Subnet1BAvailabilityZone:
    Description: Availability Zone of Subnet 1B
    Value: !GetAtt PublicSubnet1B.AvailabilityZone
  VpcId:
    Description: Vpc Id
    Value: !Ref VPC
  VPCMainRouteTableId:
    Description: Custom VPC Main Route Table Id
    Value: !GetAtt CustomResourceLambdaTrigger.RouteTableID
